CREATE OR REPLACE VIEW `financial_warehouse.vw_equity_analytics` AS
WITH RawData AS (
    SELECT 
        ticker_key,
        date,
        COALESCE(ebit, 0) AS ebit,
        COALESCE(d_and_a, 0) AS d_and_a,                
        COALESCE(interest_expense, 0) AS interest_expense,
        COALESCE(tax_provision, 0) AS tax_provision,
        COALESCE(inventory, 0) AS inventory,
        COALESCE(accounts_receivable, 0) AS accounts_receivable,
        COALESCE(accounts_payable, 0) AS accounts_payable,
        COALESCE(long_term_debt, 0) AS long_term_debt,
        COALESCE(short_term_debt, 0) AS short_term_debt,
        COALESCE(cash_and_equivalents, 0) AS cash_and_equivalents,
        COALESCE(total_equity, 0) AS total_equity,
        COALESCE(total_revenue, 0) AS total_revenue,
        COALESCE(shares_outstanding_hist, 0) AS shares_outstanding_hist,
        COALESCE(net_income, 0) AS net_income,
        COALESCE(price_at_report, 0) AS price, 
        ABS(COALESCE(capex, 0)) AS capex,
        ABS(COALESCE(dividends_paid, 0)) AS dividends_paid,
        ABS(COALESCE(stock_buybacks, 0)) AS stock_buybacks,
        ABS(COALESCE(debt_repayment, 0)) AS debt_repayment,
        ABS(COALESCE(m_and_a, 0)) AS m_and_a
    FROM `financial_warehouse.fact_fundamentals`
),
CalculatedMetrics AS (
    SELECT 
        *,
        -- If the LAG is NULL, we assume that the variation is 0
        (inventory + accounts_receivable - accounts_payable) - 
        COALESCE(LAG(inventory + accounts_receivable - accounts_payable) 
        OVER (PARTITION BY ticker_key ORDER BY date), 0) AS working_capital_change,                
        
        -- Maintenance CAPEX
        LEAST(capex, d_and_a) AS maintenance_capex,
        -- Growth CAPEX
        GREATEST(0, capex - d_and_a) AS growth_capex,

        -- OPEX
        (total_revenue - ebit) AS opex,
        
        -- FCF Calculation
        (ebit + d_and_a - interest_expense - tax_provision - 
         COALESCE(((inventory + accounts_receivable - accounts_payable) - 
          LAG(inventory + accounts_receivable - accounts_payable) 
          OVER (PARTITION BY ticker_key ORDER BY date)), 0)
         - LEAST(capex, d_and_a)) AS fcf,
         
        -- Net Debt Calculation
        (long_term_debt + short_term_debt - cash_and_equivalents) AS net_debt,

        SAFE_DIVIDE(
            (long_term_debt + short_term_debt - cash_and_equivalents), 
            (ebit + d_and_a)
        ) AS net_debt_ebitda,
        
        -- EPS Calculation
        SAFE_DIVIDE(net_income, shares_outstanding_hist) AS eps

    FROM RawData
),
YoYCalculations AS (
    SELECT
        *,
        -- 3. Year over Year Growth (YoY)
        SAFE_DIVIDE(total_revenue - LAG(total_revenue) OVER (PARTITION BY ticker_key ORDER BY date), ABS(LAG(total_revenue) OVER (PARTITION BY ticker_key ORDER BY date))) AS revenue_yoy,
        SAFE_DIVIDE(ebit - LAG(ebit) OVER (PARTITION BY ticker_key ORDER BY date), ABS(LAG(ebit) OVER (PARTITION BY ticker_key ORDER BY date))) AS ebit_yoy,
        SAFE_DIVIDE(eps - LAG(eps) OVER (PARTITION BY ticker_key ORDER BY date), ABS(LAG(eps) OVER (PARTITION BY ticker_key ORDER BY date))) AS eps_yoy,
        SAFE_DIVIDE(fcf - LAG(fcf) OVER (PARTITION BY ticker_key ORDER BY date), ABS(LAG(fcf) OVER (PARTITION BY ticker_key ORDER BY date))) AS fcf_yoy,
        SAFE_DIVIDE(shares_outstanding_hist - LAG(shares_outstanding_hist) OVER (PARTITION BY ticker_key ORDER BY date), ABS(LAG(shares_outstanding_hist) OVER (PARTITION BY ticker_key ORDER BY date))) AS shares_yoy
    FROM CalculatedMetrics
)
SELECT 
    d.ticker_key,
    d.company_name,
    d.sector,
    d.location,
    f.date AS fiscal_date,
    f.shares_outstanding_hist,

    -- Growth Metrics
    f.total_revenue,
    f.revenue_yoy,
    f.ebit_yoy,
    f.fcf_yoy,
    f.eps_yoy,
    f.shares_yoy,
    f.ebit,

    -- Historical Valuation Ratios
    f.price AS price_at_fiscal_date,
    SAFE_DIVIDE(f.price * f.shares_outstanding_hist, f.net_income) AS per_hist,
    SAFE_DIVIDE(
        (f.price * f.shares_outstanding_hist) + f.net_debt,
        f.fcf
    ) AS ev_fcf_hist,

    
    -- Valuation Bases (NOTE: Market Cap is as of today, not historical.)
    d.current_price,
    d.current_market_cap,

    -- Price CAGR
    SAFE_DIVIDE(
        POWER(
            -- Final Value / Initial Value (ensuring not to divide by zero)
            SAFE_DIVIDE(f.price, FIRST_VALUE(f.price) OVER (PARTITION BY f.ticker_key ORDER BY f.date ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)), 
            -- Exponent (1 / number of years)
            SAFE_DIVIDE(1, NULLIF(MAX(EXTRACT(YEAR FROM f.date)) OVER (PARTITION BY f.ticker_key) - MIN(EXTRACT(YEAR FROM f.date)) OVER (PARTITION BY f.ticker_key), 0))
        ) - 1,
        1
    ) AS price_cagr,
    
    f.fcf,
    f.working_capital_change,
    f.net_debt,
    f.net_debt_ebitda,
    f.maintenance_capex,
    f.opex,
    
    -- Enterprise Value (NOTE: Debt is historical, Market Cap is current)
    (d.current_market_cap + f.long_term_debt + f.short_term_debt - f.cash_and_equivalents) AS ev_current,
    
    -- EV / FCF
    SAFE_DIVIDE(                
        (d.current_market_cap + f.long_term_debt + f.short_term_debt - f.cash_and_equivalents),                
        f.fcf
    ) AS ev_fcf,
    
    -- PER
    SAFE_DIVIDE(d.current_price, SAFE_DIVIDE(f.net_income, f.shares_outstanding_hist)) AS per,

    -- ROIC
    SAFE_DIVIDE(
        (f.ebit * (1 - SAFE_DIVIDE(f.tax_provision, (f.ebit - f.interest_Expense)))),
        (f.total_equity + f.long_term_debt + f.short_term_debt - f.cash_and_equivalents)
    ) AS roic,

    -- Profit Margins
    SAFE_DIVIDE(f.ebit, f.total_revenue) AS ebit_margin,
    SAFE_DIVIDE(f.net_income, f.total_revenue) AS net_profit_margin,
    SAFE_DIVIDE(f.fcf, f.total_revenue) AS fcf_margin,
    
    -- EPS
    f.eps,

    -- FCF per share
    SAFE_DIVIDE(f.fcf, f.shares_outstanding_hist) AS fcf_per_share,  
    
    -- Capital Management
    f.growth_capex,
    f.m_and_a,
    f.stock_buybacks,
    f.dividends_paid,
    f.debt_repayment,

    -- Capital Management Allocation Ratios
    -- Growth CAPEX / FCF
    CASE 
        WHEN f.fcf > 0 THEN SAFE_DIVIDE(f.growth_capex, f.fcf) 
        ELSE 0 
    END AS prc_growth_capex,
    
   -- M&A / FCF
    CASE 
        WHEN f.fcf > 0 THEN SAFE_DIVIDE(f.m_and_a, f.fcf) 
        ELSE 0 
    END AS prc_m_and_a,

    -- Stock Buybacks / FCF
    CASE 
        WHEN f.fcf > 0 THEN SAFE_DIVIDE(f.stock_buybacks, f.fcf) 
        ELSE 0
    END AS prc_buybacks,

    -- Dividends Paid / FCF
    CASE 
        WHEN f.fcf > 0 THEN SAFE_DIVIDE(f.dividends_paid, f.fcf) 
        ELSE 0
    END AS prc_dividends,

    -- Debt Repayment / FCF
    CASE 
        WHEN f.fcf > 0 THEN SAFE_DIVIDE(f.debt_repayment, f.fcf) 
        ELSE 0 
    END AS prc_debt_repayment,

    SAFE_DIVIDE(f.maintenance_capex, f.total_revenue) AS prc_maintenance_capex,
 
    "LTM Data - Professional FCF Calculation & Margins" AS data_notes

FROM YoYCalculations f
LEFT JOIN `financial_warehouse.dim_company_info` d 
  ON f.ticker_key = d.ticker_key                
WHERE d.sector NOT IN ('Financial Services', 'Financials', 'Banks', 'Capital Markets', 'Insurance', 'Real Estate')
  AND d.current_market_cap < 10000000000
  AND EXTRACT(YEAR FROM f.date) > 2021;